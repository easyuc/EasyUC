#!/bin/bash

if [ ! -e COPYRIGHT.txt ];
then echo must be run from the uc-dsl directory!;
     exit 1;
fi

# determine whether we should build ucdsl with coverage instrumentation
coverage_mode=NO
if [[ $# -eq 1 && $1 == coverage ]];
then coverage_mode=YES;
else coverage_mode=NO;
fi

ucprelude=$(pwd)/prelude

cd ucdsl-proj

ectheories=$(ls -l ECtheories | sed 's/^.*-> //')

cd src

# the following depends on $ectheories not including apostrophes
# see configure
sed -e "s'ECtheories'$ectheories'" \
    -e "s'UCprelude'$ucprelude'" \
    -e '1i\
      (* file automatically generated from ucConfig.ml.in  - do not edit *)\
      \ ' \
    ucConfig.ml.in > ucConfig.ml
if [[ $? != 0 ]];
then echo failure;
     echo exiting...
     exit;
fi

cd ..

if [[ $coverage_mode == NO ]];
then dune build;
else dune build --instrument-with bisect_ppx;
fi

ucdsl_exec=_build/default/src/ucdsl.exe

if [ -e $ucdsl_exec ];
then mkdir -p ../bin;
     cp -f $ucdsl_exec ../bin/ucdsl;
fi
